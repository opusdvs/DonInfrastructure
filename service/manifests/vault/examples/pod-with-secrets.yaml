---
# Пример: Pod с инжекцией секретов из Vault
# 
# Перед использованием:
# 1. Настройте Kubernetes Auth в Vault (см. VAULT_SECRETS_INJECTION.md)
# 2. Сохраните секреты в Vault: vault kv put secret/myapp/config username=admin password=secret
# 3. Создайте роль в Vault: vault write auth/kubernetes/role/myapp bound_service_account_names=default policies=myapp-policy
apiVersion: v1
kind: Pod
metadata:
  name: myapp-example
  namespace: default
  annotations:
    # Включить Vault Agent Injector
    vault.hashicorp.com/agent-inject: "true"
    
    # Путь к секрету в Vault (KV v2)
    vault.hashicorp.com/agent-inject-secret-config: "secret/data/myapp/config"
    
    # Шаблон для форматирования секретов (формат .env)
    vault.hashicorp.com/agent-inject-template-config: |
      {{- with secret "secret/data/myapp/config" }}
      {{ range $k, $v := .Data.data }}
      {{ $k }}={{ $v }}
      {{ end }}
      {{- end }}
    
    # Путь к файлу в поде, куда сохранить секреты
    vault.hashicorp.com/agent-inject-file-config: "/vault/secrets/config.env"
    
    # Kubernetes Auth Role для аутентификации
    vault.hashicorp.com/role: "myapp"
spec:
  serviceAccountName: default
  containers:
    - name: myapp
      image: nginx:alpine
      volumeMounts:
        - name: vault-secrets
          mountPath: /vault/secrets
          readOnly: true
      # Пример: использовать секреты в entrypoint
      # command: ["/bin/sh", "-c", "source /vault/secrets/config.env && nginx -g 'daemon off;'"]
  volumes:
    - name: vault-secrets
      emptyDir: {}
