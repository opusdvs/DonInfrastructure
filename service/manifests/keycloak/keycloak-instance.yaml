---
# Keycloak Custom Resource
# Использует внешний PostgreSQL для хранения данных
apiVersion: k8s.keycloak.org/v2alpha1
kind: Keycloak
metadata:
  name: keycloak
  namespace: keycloak
  labels:
    app: keycloak
spec:
  # Количество реплик Keycloak
  instances: 1
  
  # Хостнейм для доступа к Keycloak
  hostname:
    hostname: keycloak.buildbyte.ru
    strict: false  # Отключить строгую проверку hostname
  
  # HTTP настройки
  http:
    httpEnabled: true
    tlsSecret: ""  # Пустая строка означает использование HTTP (без TLS)
  
  # Proxy настройки (для работы за Gateway)
  proxy:
    headers: xforwarded
  
  # Ресурсы для контейнера Keycloak
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 2Gi
  
  # Дополнительные опции для Keycloak
  additionalOptions:
    - name: health-enabled
      value: "true"
    - name: metrics-enabled
      value: "true"
  
  # Настройки для production (опционально)
  # production: false  # По умолчанию false для development режима
  
  # Конфигурация базы данных PostgreSQL
  db:
    vendor: postgres
    host: postgresql.postgresql.svc.cluster.local
    port: 5432
    database: keycloak
    usernameSecret:
      name: keycloak-db-credentials
      key: username
    passwordSecret:
      name: keycloak-db-credentials
      key: password
  
  # Bootstrap администратор Keycloak
  # Использует секрет keycloak-admin-credentials, созданный Vault Secrets Operator
  bootstrapAdmin:
    user:
      secret: keycloak-admin-credentials
  
  # Unsupported настройки (для расширенной конфигурации)
  unsupported:
    podTemplate:
      spec:
        containers:
          - name: keycloak
            env:
              # Health и metrics
              - name: KC_HEALTH_ENABLED
                value: "true"
              - name: KC_METRICS_ENABLED
                value: "true"
              # Отключить кластеризацию для standalone режима (один экземпляр)
              # Использовать локальный кеш вместо распределенного (JGroups)
              - name: KC_CACHE
                value: "local"
            startupProbe:
              httpGet:
                path: /health/started
                port: 9000
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 30
            livenessProbe:
              httpGet:
                path: /health/live
                port: 9000
              initialDelaySeconds: 60
              periodSeconds: 30
              timeoutSeconds: 10
              failureThreshold: 5
            readinessProbe:
              httpGet:
                path: /health/ready
                port: 9000
              initialDelaySeconds: 60
              periodSeconds: 15
              timeoutSeconds: 10
              failureThreshold: 5
