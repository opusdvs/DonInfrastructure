---
# ClusterSecretStore для подключения External Secrets Operator к внешнему Vault (Dev кластер)
# Vault находится в services кластере и доступен через Gateway по адресу https://vault.buildbyte.ru
# 
# Использование:
# 1. Убедитесь, что External Secrets Operator установлен и CRD созданы:
#    kubectl get crd | grep external-secrets
# 2. Убедитесь, что Vault в services кластере настроен для Kubernetes auth (mountPath: kubernetes-dev)
# 3. Убедитесь, что роль external-secrets-operator создана в Vault для dev кластера
# 4. Примените манифест: kubectl apply -f manifests/dev/external-secrets/vault-cluster-secret-store.yaml

apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: vault
spec:
  provider:
    vault:
      # Адрес Vault сервера в services кластере через Gateway
      # Vault доступен по адресу https://vault.buildbyte.ru через HTTPRoute
      server: "https://vault.buildbyte.ru"
      # Путь к секретам (версия KV v2)
      version: "v2"
      # Аутентификация через Kubernetes ServiceAccount
      auth:
        kubernetes:
          # Mount path для Kubernetes auth в Vault (kubernetes-dev для dev кластера)
          mountPath: "kubernetes-dev"
          # Роль в Vault для External Secrets Operator
          role: "external-secrets-operator"
          # ServiceAccount для аутентификации
          serviceAccountRef:
            name: external-secrets
            namespace: external-secrets-system
