---
# ExternalSecret для синхронизации Docker Registry credentials для использования в Kubernetes ImagePullSecrets
# Использование:
# 1. Убедитесь, что .dockerconfigjson сохранен в Vault по пути secret/kubernetes/docker-registry с ключом dockerconfigjson
# 2. Убедитесь, что ClusterSecretStore для Vault настроен в dev кластере
# 3. Примените манифест в dev кластере: kubectl apply -f manifests/dev/docker-registry/docker-registry-externalsecret.yaml
# 4. Используйте Secret в ImagePullSecrets для подов, которым нужен доступ к приватному Docker Registry
#
# Примечание: Этот ExternalSecret создается в dev кластере, так как Docker Registry credentials нужны
# для pull образов в dev кластере, где развертываются приложения

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: docker-registry-credentials
  namespace: donweather
  labels:
    app: docker-registry
    component: credentials
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault
    kind: ClusterSecretStore
  target:
    name: docker-registry-credentials
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ .dockerconfigjson }}"
  data:
    - secretKey: dockerconfigjson
      remoteRef:
        key: secret/kubernetes/docker-registry
        property: dockerconfigjson
