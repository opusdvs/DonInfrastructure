---
# Job для создания баз данных и пользователей в PostgreSQL
# Запускается после деплоя PostgreSQL для создания необходимых баз
#
# Использование:
#   1. Добавьте базы данных в ConfigMap database-provisioner-config
#   2. Добавьте пароли в Secret database-provisioner-secrets
#   3. Примените манифест: kubectl apply -f manifests/services/postgresql/database-provisioner-job.yaml
#
# Для повторного запуска (создания новых баз):
#   kubectl delete job database-provisioner -n postgresql
#   kubectl apply -f manifests/services/postgresql/database-provisioner-job.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: database-provisioner-config
  namespace: postgresql
  labels:
    app: database-provisioner
data:
  # Список баз данных для создания (формат: database:username)
  # Добавляйте новые базы здесь
  databases.txt: |
    keycloak:keycloak
    # Примеры для других сервисов:
    # myapp:myapp_user
    # analytics:analytics_user
---
apiVersion: batch/v1
kind: Job
metadata:
  name: database-provisioner
  namespace: postgresql
  labels:
    app: database-provisioner
  annotations:
    # Для ArgoCD - запускать после PostgreSQL
    argocd.argoproj.io/sync-wave: "2"
spec:
  ttlSecondsAfterFinished: 300  # Удалить Job через 5 минут после завершения
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: database-provisioner
    spec:
      restartPolicy: OnFailure
      containers:
        - name: provisioner
          image: bitnami/postgresql:16
          env:
            - name: PGHOST
              value: "postgresql.postgresql.svc.cluster.local"
            - name: PGPORT
              value: "5432"
            - name: PGUSER
              value: "postgres"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-admin-credentials
                  key: postgres_password
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "=== Database Provisioner ==="
              echo "Waiting for PostgreSQL to be ready..."
              
              # Ждём готовности PostgreSQL
              until pg_isready -h $PGHOST -p $PGPORT -U $PGUSER; do
                echo "PostgreSQL is unavailable - sleeping"
                sleep 2
              done
              echo "PostgreSQL is ready!"
              
              # Читаем конфигурацию баз данных
              while IFS=: read -r database username || [ -n "$database" ]; do
                # Пропускаем пустые строки и комментарии
                [[ -z "$database" || "$database" =~ ^[[:space:]]*# ]] && continue
                
                # Убираем пробелы
                database=$(echo "$database" | xargs)
                username=$(echo "$username" | xargs)
                
                echo "Processing database: $database, user: $username"
                
                # Получаем пароль из Secret (ключ: <database>_password)
                password_key="${database}_password"
                password=$(cat /secrets/${password_key} 2>/dev/null || echo "")
                
                if [ -z "$password" ]; then
                  echo "WARNING: No password found for $database (key: $password_key), skipping..."
                  continue
                fi
                
                # Создаём базу данных (если не существует)
                echo "Creating database $database..."
                psql -c "SELECT 1 FROM pg_database WHERE datname = '$database'" | grep -q 1 || \
                  psql -c "CREATE DATABASE $database;"
                
                # Создаём пользователя (если не существует)
                echo "Creating user $username..."
                psql -c "SELECT 1 FROM pg_roles WHERE rolname = '$username'" | grep -q 1 || \
                  psql -c "CREATE USER $username WITH ENCRYPTED PASSWORD '$password';"
                
                # Обновляем пароль (на случай если изменился)
                psql -c "ALTER USER $username WITH ENCRYPTED PASSWORD '$password';"
                
                # Выдаём права
                echo "Granting privileges..."
                psql -c "GRANT ALL PRIVILEGES ON DATABASE $database TO $username;"
                psql -d "$database" -c "GRANT ALL ON SCHEMA public TO $username;"
                
                echo "Database $database configured successfully!"
              done < /config/databases.txt
              
              echo "=== All databases provisioned ==="
          volumeMounts:
            - name: config
              mountPath: /config
            - name: secrets
              mountPath: /secrets
      volumes:
        - name: config
          configMap:
            name: database-provisioner-config
        - name: secrets
          secret:
            secretName: postgresql-admin-credentials
