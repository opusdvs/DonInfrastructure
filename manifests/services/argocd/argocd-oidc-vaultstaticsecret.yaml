---
# VaultStaticSecret для OIDC клиента Argo CD
# Синхронизирует секрет из Vault в Kubernetes Secret
#
# Vault путь: secret/argocd/oidc
# Kubernetes Secret: argocd-oidc-secret (namespace: argocd)
#
# Ключи в Vault: clientId, clientSecret (или client-id, client-secret)
# Ключи в K8s Secret: client-id, client-secret
#
# ВАЖНО: Label app.kubernetes.io/part-of: argocd позволяет Argo CD читать этот секрет!
#
# Использование:
#   kubectl apply -f manifests/services/argocd/argocd-oidc-vaultstaticsecret.yaml
#
# Проверка:
#   kubectl get secret argocd-oidc-secret -n argocd -o yaml
#   kubectl get secret argocd-oidc-secret -n argocd --show-labels
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: argocd-oidc-credentials
  namespace: argocd
  labels:
    app: argocd
    component: oidc-credentials
spec:
  # Ссылка на VaultAuth в namespace vault-secrets-operator
  vaultAuthRef: vault-secrets-operator/default
  
  # Путь к секретному движку KV v2
  mount: secret
  type: kv-v2
  
  # Путь к секрету внутри движка (без префикса mount)
  path: argocd/oidc
  
  # Интервал обновления секрета
  refreshAfter: 60s
  
  # Целевой Kubernetes Secret
  destination:
    name: argocd-oidc-secret
    create: true
    # ВАЖНО: Этот лейбл позволяет Argo CD читать секрет!
    labels:
      app.kubernetes.io/part-of: argocd
    # Трансформация ключей из Vault в формат для Argo CD
    transformation:
      excludeRaw: true
      templates:
        client-id:
          text: "{{ .Secrets.clientId }}"
        client-secret:
          text: "{{ .Secrets.clientSecret }}"
