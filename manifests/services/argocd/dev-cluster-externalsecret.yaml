---
# ExternalSecret для синхронизации kubeconfig dev кластера из Vault в Secret для Argo CD
# Использование:
# 1. Сохраните kubeconfig в Vault по пути secret/argocd/dev-cluster с ключами:
#    - name: dev-cluster
#    - server: https://<адрес-api-сервера>:6443
#    - config: JSON строка с bearerToken и tlsClientConfig
# 2. Убедитесь, что ClusterSecretStore для Vault настроен
# 3. Примените манифест: kubectl apply -f manifests/services/argocd/dev-cluster-externalsecret.yaml
# 4. Argo CD автоматически обнаружит кластер через метку argocd.argoproj.io/secret-type: cluster

apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: dev-cluster-secret
  namespace: argocd
  labels:
    app: argocd
    component: cluster-config
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault
    kind: ClusterSecretStore
  target:
    name: dev-cluster
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
      data:
        name: "{{ .name }}"
        server: "{{ .server }}"
        config: "{{ .config }}"
  data:
    - secretKey: name
      remoteRef:
        key: secret/argocd/dev-cluster
        property: name
    - secretKey: server
      remoteRef:
        key: secret/argocd/dev-cluster
        property: server
    - secretKey: config
      remoteRef:
        key: secret/argocd/dev-cluster
        property: config
